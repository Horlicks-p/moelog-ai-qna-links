# æ¶æ§‹æ¦‚è¦½

## ğŸ“ æ•´é«”æ¶æ§‹

Moelog AI Q&A Links æ¡ç”¨æ¨¡çµ„åŒ–æ¶æ§‹è¨­è¨ˆï¼Œéµå¾ª**å–®ä¸€è·è²¬åŸå‰‡**å’Œ**ä¾è³´æ³¨å…¥**æ¨¡å¼ã€‚

### ç³»çµ±å±¤æ¬¡çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WordPress Core                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Plugin Bootstrap                          â”‚
â”‚              (moelog-ai-qna.php)                            â”‚
â”‚  - å®šç¾©å¸¸æ•¸                                                   â”‚
â”‚  - è‡ªå‹•åŠ è¼‰å™¨                                                 â”‚
â”‚  - åˆå§‹åŒ–æ ¸å¿ƒ                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Core Coordinator                           â”‚
â”‚            (Moelog_AIQnA_Core)                              â”‚
â”‚  - å–®ä¾‹æ¨¡å¼ç®¡ç†                                               â”‚
â”‚  - æ¨¡çµ„åˆå§‹åŒ–                                                 â”‚
â”‚  - é‰¤å­è¨»å†Š                                                   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚         â”‚         â”‚         â”‚         â”‚
    â–¼        â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Routerâ”‚ â”‚  AI  â”‚ â”‚Cache â”‚ â”‚Renderâ”‚ â”‚Admin â”‚ â”‚Assetsâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚         â”‚
    â–¼        â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Feedbkâ”‚ â”‚ GEO  â”‚ â”‚PreGenâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© æ ¸å¿ƒæ¨¡çµ„

### 1. Core (æ ¸å¿ƒå”èª¿å™¨)

**æ–‡ä»¶**: `includes/class-core.php`

**è·è²¬**:

- ç®¡ç†æ’ä»¶ç”Ÿå‘½é€±æœŸ
- åˆå§‹åŒ–æ‰€æœ‰å­æ¨¡çµ„
- è¨»å†Š WordPress é‰¤å­
- æä¾›å–®ä¾‹å­˜å–é»

**ä¸»è¦æ–¹æ³•**:

```php
class Moelog_AIQnA_Core {
    // å–®ä¾‹å¯¦ä¾‹
    private static $instance = null;

    // æ¨¡çµ„å¯¦ä¾‹
    private $router;
    private $ai_client;
    private $renderer;
    private $cache;
    private $admin;

    // å–å¾—å–®ä¾‹
    public static function get_instance();

    // åˆå§‹åŒ–ä¾è³´
    private function load_dependencies();

    // è¨»å†Šé‰¤å­
    private function register_hooks();

    // å»ºç«‹ç­”æ¡ˆ URL
    public function build_answer_url($post_id, $question);
}
```

**è¨­è¨ˆæ¨¡å¼**:

- **å–®ä¾‹æ¨¡å¼** (Singleton) - ç¢ºä¿åªæœ‰ä¸€å€‹æ ¸å¿ƒå¯¦ä¾‹
- **å·¥å» æ¨¡å¼** (Factory) - å‰µå»ºå’Œç®¡ç†å­æ¨¡çµ„

---

### 2. Router (è·¯ç”±è™•ç†å™¨)

**æ–‡ä»¶**: `includes/class-router.php`

**è·è²¬**:

- è¨»å†Šè‡ªå®šç¾© URL è¦å‰‡
- è§£æè«‹æ±‚åƒæ•¸
- é©—è­‰ URL ç°½åï¼ˆHMACï¼‰
- åˆ†ç™¼è«‹æ±‚åˆ°ç›¸æ‡‰è™•ç†å™¨

**URL çµæ§‹**:

```
https://example.com/qna/{slug}-{hash}-{id}/
                         â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜ â””â”¬â”˜
                           â”‚     â”‚    â””â”€ æ–‡ç«  ID (Base36)
                           â”‚     â””â”€â”€â”€â”€â”€â”€ HMAC ç°½å (3å­—ç¬¦)
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ URL å‹å¥½çš„ slug
```

**å·¥ä½œæµç¨‹**:

```mermaid
graph LR
    A[ç”¨æˆ¶è«‹æ±‚] --> B{URLæ ¼å¼æ­£ç¢º?}
    B -->|å¦| C[404éŒ¯èª¤]
    B -->|æ˜¯| D{HMACé©—è­‰}
    D -->|å¤±æ•—| E[403éŒ¯èª¤]
    D -->|æˆåŠŸ| F[è§£æåƒæ•¸]
    F --> G[å‚³éçµ¦Renderer]
```

**é—œéµä»£ç¢¼**:

```php
class Moelog_AIQnA_Router {
    public function register_routes() {
        // è¨»å†Š rewrite rule
        add_rewrite_rule(
            '^qna/([^/]+)/?$',
            'index.php?moe_ai=1&moe_slug=$matches[1]',
            'top'
        );
    }

    public function parse_request() {
        // è§£æå’Œé©—è­‰è«‹æ±‚
        $slug = get_query_var('moe_slug');
        list($post_id, $hash, $question) = $this->parse_slug($slug);

        // HMAC é©—è­‰
        if (!$this->verify_signature($post_id, $question, $hash)) {
            wp_die('Invalid URL', 403);
        }

        return compact('post_id', 'question');
    }
}
```

---

### 3. AI Client (AI æœå‹™å®¢æˆ¶ç«¯)

**æ–‡ä»¶**: `includes/class-ai-client.php`

**è·è²¬**:

- ç®¡ç†å¤šå€‹ AI æä¾›å•†
- è™•ç† API èªè­‰
- å¯¦ç¾é‡è©¦æ©Ÿåˆ¶
- ç®¡ç† API å¿«å–

**æ”¯æ´çš„æä¾›å•†**:

- OpenAI (GPT-4o-mini, GPT-4o ç­‰)
- Google Gemini (Gemini 2.5 Flash/Pro ç­‰)
- Anthropic Claude (Claude Opus, Sonnet ç­‰)

**æ¶æ§‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AI_Client (çµ±ä¸€æ¥å£)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  + generate_answer()                â”‚
â”‚  + test_connection()                â”‚
â”‚  + clear_cache()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚OpenAI  â”‚ â”‚Gemini  â”‚ â”‚Claudeâ”‚ â”‚Futureâ”‚
â”‚Handler â”‚ â”‚Handler â”‚ â”‚Handlerâ”‚ â”‚ ...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

**è«‹æ±‚æµç¨‹**:

```mermaid
sequenceDiagram
    participant C as Caller
    participant AI as AI_Client
    participant Cache as Transient Cache
    participant API as External API

    C->>AI: generate_answer($params)
    AI->>Cache: æª¢æŸ¥å¿«å–

    alt å¿«å–å‘½ä¸­
        Cache-->>AI: è¿”å›å¿«å–ç­”æ¡ˆ
        AI-->>C: è¿”å›ç­”æ¡ˆ
    else å¿«å–æœªå‘½ä¸­
        AI->>AI: æº–å‚™ Prompt
        AI->>API: HTTP Request (with retry)
        API-->>AI: API Response
        AI->>AI: è§£æéŸ¿æ‡‰
        AI->>Cache: ä¿å­˜å¿«å–
        AI-->>C: è¿”å›ç­”æ¡ˆ
    end
```

**é‡è©¦æ©Ÿåˆ¶**:

```php
private function request_with_retry($url, $args, $max_retries = 3) {
    $attempt = 0;

    while ($attempt < $max_retries) {
        $response = wp_remote_post($url, $args);

        if (!is_wp_error($response)) {
            return $response;
        }

        $attempt++;
        // æŒ‡æ•¸é€€é¿
        sleep(pow(2, $attempt));
    }

    return $response; // æœ€å¾Œä¸€æ¬¡å˜—è©¦çš„çµæœ
}
```

---

### 4. Cache (å¿«å–ç®¡ç†å™¨)

**æ–‡ä»¶**: `includes/class-cache.php`

**è·è²¬**:

- ç®¡ç†é›™å±¤å¿«å–ç³»çµ±
- è™•ç†å¿«å–éæœŸ
- æä¾›å¿«å–çµ±è¨ˆ

**é›™å±¤å¿«å–æ¶æ§‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¿«å–å±¤ç´š                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ç¬¬ä¸€å±¤: éœæ…‹ HTML æ–‡ä»¶                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ wp-content/ai-answers/                 â”‚     â”‚
â”‚  â”‚  â””â”€ {post_id}-{hash}.html              â”‚     â”‚
â”‚  â”‚                                        â”‚     â”‚
â”‚  â”‚ å„ªé»: æ¥µå¿«çš„è®€å–é€Ÿåº¦                    â”‚     â”‚
â”‚  â”‚ ç¼ºé»: éœ€è¦æ–‡ä»¶ç³»çµ±è¨ªå•                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â†•                                â”‚
â”‚  ç¬¬äºŒå±¤: WordPress Transient                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ wp_options è¡¨                          â”‚     â”‚
â”‚  â”‚  option_name: _transient_moe_aiqna_... â”‚     â”‚
â”‚  â”‚  option_value: AI ç”Ÿæˆçš„ç­”æ¡ˆ            â”‚     â”‚
â”‚  â”‚                                        â”‚     â”‚
â”‚  â”‚ å„ªé»: è‡ªå‹•éæœŸç®¡ç†                      â”‚     â”‚
â”‚  â”‚ æ”¯æ´: å°è±¡å¿«å–ï¼ˆRedis/Memcachedï¼‰       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â†•                                â”‚
â”‚  ç¬¬ä¸‰å±¤: ç‰©ä»¶å¿«å– (Object Cache)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ wp_cache_get()                         â”‚     â”‚
â”‚  â”‚                                        â”‚     â”‚
â”‚  â”‚ å„ªé»: è¨˜æ†¶é«”ç´šåˆ¥é€Ÿåº¦                    â”‚     â”‚
â”‚  â”‚ é©ç”¨: Meta Data, Post Objects          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¿«å–éµå€¼ç”Ÿæˆ**:

```php
private static function generate_hash($post_id, $question) {
    $secret = get_option(MOELOG_AIQNA_SECRET_KEY);
    $data = $post_id . '|' . $question;

    return substr(
        hash_hmac('sha256', $data, $secret),
        0,
        16
    );
}
```

**å¿«å–æ¸…é™¤ç­–ç•¥**:

```php
// 1. æ‰‹å‹•æ¸…é™¤
public static function delete($post_id, $question = null);

// 2. è‡ªå‹•æ¸…é™¤ï¼ˆæ–‡ç« æ›´æ–°æ™‚ï¼‰
add_action('save_post', function($post_id) {
    Moelog_AIQnA_Cache::clear_post_cache($post_id);
});

// 3. TTL éæœŸæ¸…é™¤
public static function clear_expired();
```

---

### 5. Renderer (æ¸²æŸ“å¼•æ“)

**æ–‡ä»¶**: `includes/class-renderer.php`

**è·è²¬**:

- ç”Ÿæˆç­”æ¡ˆé é¢ HTML
- æ‡‰ç”¨æ¨¡æ¿ç³»çµ±
- æ³¨å…¥å®‰å…¨ç›¸é—œæ¨™é ­
- è™•ç† CSP nonce

**æ¸²æŸ“æµç¨‹**:

```mermaid
graph TD
    A[é–‹å§‹æ¸²æŸ“] --> B[æª¢æŸ¥éœæ…‹å¿«å–]
    B -->|å­˜åœ¨| C[è®€å– HTML]
    B -->|ä¸å­˜åœ¨| D[èª¿ç”¨ AI ç”Ÿæˆç­”æ¡ˆ]
    D --> E[è½‰æ› Markdown åˆ° HTML]
    E --> F[æ‡‰ç”¨å®‰å…¨éæ¿¾]
    F --> G[è¼‰å…¥æ¨¡æ¿]
    G --> H[æ›¿æ›ä½”ä½ç¬¦]
    H --> I[ä¿å­˜éœæ…‹å¿«å–]
    C --> J[æ›¿æ›å‹•æ…‹å…§å®¹]
    I --> J
    J --> K[è¼¸å‡º HTML]
```

**æ¨¡æ¿ç³»çµ±**:

```php
// æ¨¡æ¿å„ªå…ˆç´š
1. {ä¸»é¡Œç›®éŒ„}/moelog-ai-qna/answer-page.php
2. {æ’ä»¶ç›®éŒ„}/templates/answer-page.php (é»˜èª)

// æ¨¡æ¿è®Šæ•¸
$template_vars = [
    'question'     => $question,
    'answer'       => $answer_html,
    'post_id'      => $post_id,
    'post_title'   => get_the_title($post_id),
    'post_url'     => get_permalink($post_id),
    'nonce'        => wp_create_nonce('moelog_aiqna'),
    'settings'     => $settings,
];
```

**CSP å®‰å…¨**:

```php
// ç”Ÿæˆå”¯ä¸€ nonce
$nonce = wp_create_nonce('moelog_aiqna_csp_' . time());

// è¨­ç½® CSP æ¨™é ­
header(sprintf(
    "Content-Security-Policy: default-src 'self'; script-src 'nonce-%s'; style-src 'nonce-%s'",
    $nonce,
    $nonce
));

// åœ¨ HTML ä¸­ä½¿ç”¨
echo '<script nonce="' . esc_attr($nonce) . '">...</script>';
```

---

### 6. Admin (å¾Œå°ç®¡ç†)

**æ–‡ä»¶**: `includes/class-admin.php`, `includes/class-admin-settings.php`

**è·è²¬**:

- è¨­å®šé é¢æ¸²æŸ“
- é¸é …é©—è­‰å’Œä¿å­˜
- ç®¡ç†ç•Œé¢ AJAX è™•ç†
- ç³»çµ±ç‹€æ…‹ç›£æ§

**è¨­å®šé é¢çµæ§‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¨­å®š â†’ Moelog AI Q&A         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‘ åˆ†é å°èˆª                          â”‚
â”‚ [ä¸€èˆ¬] [é¡¯ç¤º] [å¿«å–è¨­å®š] [ç³»çµ±è³‡è¨Š]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ä¸€èˆ¬è¨­å®š:                           â”‚
â”‚  â”œâ”€ AI ä¾›æ‡‰å•†é¸æ“‡                    â”‚
â”‚  â”œâ”€ API é‡‘é‘° (åŠ å¯†å­˜å„²)              â”‚
â”‚  â”œâ”€ æ¨¡å‹é¸æ“‡                         â”‚
â”‚  â””â”€ Temperature è¨­å®š                â”‚
â”‚                                     â”‚
â”‚  å…§å®¹è¨­å®š:                           â”‚
â”‚  â”œâ”€ åŒ…å«æ–‡ç« å…§å®¹                     â”‚
â”‚  â”œâ”€ å…§å®¹æˆªæ–·é•·åº¦                     â”‚
â”‚  â””â”€ System Prompt                  â”‚
â”‚                                     â”‚
â”‚  é¡¯ç¤ºè¨­å®š:                           â”‚
â”‚  â”œâ”€ å•é¡Œæ¸…å–®æ¨™é¡Œ                     â”‚
â”‚  â”œâ”€ å…è²¬è²æ˜                         â”‚
â”‚  â””â”€ STM æ¨¡å¼                        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7. Metabox (æ–‡ç« ç·¨è¼¯å™¨)

**æ–‡ä»¶**: `includes/class-metabox.php`

**è·è²¬**:

- åœ¨æ–‡ç« ç·¨è¼¯é é¡¯ç¤ºå•é¡Œç®¡ç†ç•Œé¢
- æ”¯æ´æ‹–æ›³æ’åº
- å³æ™‚é è¦½
- AJAX ä¿å­˜

**ç•Œé¢çµæ§‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AI å•é¡Œæ¸…å–®ç®¡ç†                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•é¡Œ 1:                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ é€™ç¯‡æ–‡ç« çš„ä¸»è¦é‡é»æ˜¯ä»€éº¼ï¼Ÿ        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [ğŸ”§ é è¦½] [ğŸ—‘ï¸ åˆªé™¤] [â¬ æ‹–æ›³]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•é¡Œ 2: ...                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â• æ–°å¢å•é¡Œ]                        â”‚
â”‚ [ğŸ”„ é‡æ–°ç”Ÿæˆå…¨éƒ¨] [ğŸ—‘ï¸ æ¸…é™¤å¿«å–]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‹–æ›³æ’åºå¯¦ç¾**:

```javascript
jQuery(".moelog-aiqna-questions-list").sortable({
  handle: ".drag-handle",
  update: function (event, ui) {
    // æ›´æ–°å•é¡Œé †åº
    updateQuestionOrder();
  },
});
```

---

### 8. Feedback (åé¥‹ç³»çµ±)

**æ–‡ä»¶**: `includes/class-feedback-controller.php`

**è·è²¬**:

- è¨˜éŒ„ä½¿ç”¨è€…å°ç­”æ¡ˆçš„è©•åƒ¹ï¼ˆğŸ‘/ğŸ‘ï¼‰
- é˜²æ­¢é‡è¤‡è©•åƒ¹ï¼ˆåŸºæ–¼ Cookie/IPï¼‰
- æä¾›çµ±è¨ˆæ•¸æ“š API

**æ•¸æ“šå­˜å„²**:

- **Meta Key**: `_moelog_aiqna_feedback_stats_{hash}`
- **æ ¼å¼**: `['likes' => 10, 'dislikes' => 2]`

---

### 9. GEO/STM (çµæ§‹åŒ–è³‡æ–™æ¨¡å¼) - _å¯é¸_

**æ–‡ä»¶**: `moelog-ai-geo.php`

> **å‘½åèªªæ˜**: æ¨¡çµ„åŸå GEOï¼Œç¾å·²æ›´åç‚º STM (Structured Data Mode)ï¼Œä½†æª”æ¡ˆåç¨±ä¿æŒä¸è®Šä»¥ç¶­è­·å‘å¾Œç›¸å®¹æ€§ã€‚

**è·è²¬**:

- æ³¨å…¥ Schema.org çµæ§‹åŒ–è³‡æ–™ (QAPage, BreadcrumbList)
- è¼¸å‡º SEO Meta æ¨™ç±¤ (OG, Twitter Card)
- ç”¢ç”Ÿ AI å•ç­”å°ˆç”¨ Sitemap
- è¨­å®š CDN å‹å–„çš„ HTTP å¿«å–æ¨™é ­
- ç®¡ç†æœå°‹å¼•æ“çˆ¬èŸ²ç™½åå–®

**å·¥ä½œåŸç†**:

1. åœ¨ç­”æ¡ˆé  `<head>` æ³¨å…¥ JSON-LD çµæ§‹åŒ–è³‡æ–™
2. è¨­å®š `index,follow` robots æ¨™ç±¤ï¼ˆå–ä»£é è¨­ `noindex`ï¼‰
3. ç”¢ç”Ÿ Sitemap index + åˆ†é ï¼ˆæœ€å¤š 49,000 URL/é ï¼‰
4. å›æ‡‰æ¢ä»¶å¼è«‹æ±‚ï¼ˆ304 Not Modifiedï¼‰

**è©³ç´°èªªæ˜**: è«‹åƒé–± [stm-mode.md](stm-mode.md)

---

## ğŸ” å®‰å…¨æ¶æ§‹

### 1. API é‡‘é‘°åŠ å¯†

```
æ˜æ–‡ API Key
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AES-256-CBC åŠ å¯†     â”‚
â”‚  + WordPress Salts   â”‚
â”‚  + éš¨æ©Ÿ IV           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     åŠ å¯†å¾Œçš„å­—ä¸²
     (å­˜å„²åœ¨è³‡æ–™åº«)
```

**å¯¦ç¾**:

```php
// åŠ å¯†
function moelog_aiqna_encrypt_api_key($plain_key) {
    $key = hash('sha256', wp_salt('auth'));
    $iv = openssl_random_pseudo_bytes(16);

    $encrypted = openssl_encrypt(
        $plain_key,
        'AES-256-CBC',
        $key,
        0,
        $iv
    );

    return base64_encode($iv . $encrypted);
}

// è§£å¯†
function moelog_aiqna_decrypt_api_key($encrypted_key) {
    $data = base64_decode($encrypted_key);
    $iv = substr($data, 0, 16);
    $encrypted = substr($data, 16);
    $key = hash('sha256', wp_salt('auth'));

    return openssl_decrypt(
        $encrypted,
        'AES-256-CBC',
        $key,
        0,
        $iv
    );
}
```

### 2. HMAC URL ç°½å

é˜²æ­¢ URL è¢«çŒœæ¸¬æˆ–ç¯¡æ”¹ï¼š

```php
function generate_url_signature($post_id, $question) {
    $secret = get_option(MOELOG_AIQNA_SECRET_KEY);
    $data = $post_id . '|' . $question;

    return substr(
        hash_hmac('sha256', $data, $secret),
        0,
        3  // å–å‰3å€‹å­—ç¬¦
    );
}
```

### 3. å…§å®¹å®‰å…¨ç­–ç•¥ (CSP)

```http
Content-Security-Policy:
    default-src 'self';
    script-src 'nonce-{RANDOM}';
    style-src 'nonce-{RANDOM}';
    img-src 'self' data:;
    font-src 'self';
    connect-src 'self';
    frame-ancestors 'none';
```

---

## ğŸ“Š æ•¸æ“šæµç¤ºä¾‹

### å®Œæ•´çš„ç­”æ¡ˆç”Ÿæˆæµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ¶
    participant WP as WordPress
    participant R as Router
    participant C as Cache
    participant AI as AI_Client
    participant RN as Renderer
    participant T as Template

    U->>WP: GET /qna/example-abc-123/
    WP->>R: è·¯ç”±è§£æ
    R->>R: é©—è­‰ HMAC ç°½å
    R->>C: æª¢æŸ¥éœæ…‹å¿«å–

    alt å¿«å–å­˜åœ¨ä¸”æœªéæœŸ
        C-->>R: è¿”å› HTML
        R->>RN: æ›¿æ›å‹•æ…‹å…§å®¹ (nonce)
        RN-->>U: è¼¸å‡º HTML
    else å¿«å–ä¸å­˜åœ¨
        C-->>R: å¿«å–æœªå‘½ä¸­
        R->>AI: è«‹æ±‚ç”Ÿæˆç­”æ¡ˆ
        AI->>AI: æª¢æŸ¥ Transient å¿«å–

        alt Transient å­˜åœ¨
            AI-->>R: è¿”å›ç­”æ¡ˆ
        else Transient ä¸å­˜åœ¨
            AI->>AI: èª¿ç”¨ OpenAI/Gemini API
            AI->>AI: ä¿å­˜ Transient
            AI-->>R: è¿”å›ç­”æ¡ˆ
        end

        R->>RN: æ¸²æŸ“ç­”æ¡ˆé 
        RN->>T: è¼‰å…¥æ¨¡æ¿
        T-->>RN: æ¨¡æ¿ HTML
        RN->>RN: æ›¿æ›è®Šæ•¸
        RN->>RN: æ‡‰ç”¨å®‰å…¨éæ¿¾
        RN->>C: ä¿å­˜éœæ…‹å¿«å–
        RN-->>U: è¼¸å‡º HTML
    end
```

---

## ğŸ”§ æ“´å±•é»

æ’ä»¶æä¾›å¤šå€‹æ“´å±•é»ä¾›é–‹ç™¼è€…è‡ªå®šç¾©ï¼š

### Hooks (å‹•ä½œé‰¤å­)

```php
// åœ¨ç”Ÿæˆç­”æ¡ˆä¹‹å‰
do_action('moelog_aiqna_before_generate', $post_id, $question);

// åœ¨ç”Ÿæˆç­”æ¡ˆä¹‹å¾Œ
do_action('moelog_aiqna_after_generate', $post_id, $question, $answer);

// åœ¨æ¸…é™¤å¿«å–æ™‚
do_action('moelog_aiqna_cache_cleared', $post_id);

// åœ¨æ¸²æŸ“ç­”æ¡ˆé ä¹‹å‰
do_action('moelog_aiqna_before_render', $post_id, $question);
```

### Filters (éæ¿¾å™¨é‰¤å­)

```php
// ä¿®æ”¹ AI è«‹æ±‚åƒæ•¸
apply_filters('moelog_aiqna_ai_params', $params, $post_id);

// ä¿®æ”¹ç”Ÿæˆçš„ç­”æ¡ˆ
apply_filters('moelog_aiqna_answer', $answer, $post_id, $question);

// ä¿®æ”¹æ¸²æŸ“çš„ HTML
apply_filters('moelog_aiqna_render_html', $html, $post_id, $question);

// ä¿®æ”¹å¿«å– TTL
apply_filters('moelog_aiqna_cache_ttl', $ttl);

// è‡ªå®šç¾©æ¨¡æ¿è·¯å¾‘
apply_filters('moelog_aiqna_template_path', $path, $template_name);
```

è©³ç´°ç”¨æ³•è«‹åƒé–± [Hooks & Filters æ–‡æª”](hooks-filters.md)ã€‚

---

## ğŸ¯ è¨­è¨ˆåŸå‰‡

### 1. å–®ä¸€è·è²¬åŸå‰‡ (SRP)

æ¯å€‹é¡åˆ¥åªè² è²¬ä¸€å€‹åŠŸèƒ½é ˜åŸŸã€‚

### 2. é–‹é–‰åŸå‰‡ (OCP)

å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰ã€‚é€šé hooks å’Œ filters å¯¦ç¾ã€‚

### 3. ä¾è³´å€’ç½®åŸå‰‡ (DIP)

é«˜å±¤æ¨¡çµ„ä¸ä¾è³´ä½å±¤æ¨¡çµ„ï¼Œéƒ½ä¾è³´æ–¼æŠ½è±¡ã€‚

### 4. æœ€å°çŸ¥è­˜åŸå‰‡

æ¨¡çµ„ä¹‹é–“ä¿æŒé¬†è€¦åˆï¼Œé€šéæ˜ç¢ºçš„æ¥å£é€šè¨Šã€‚

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å…¬å…± API åƒè€ƒ](api-reference.md)
- [Hooks & Filters](hooks-filters.md)
- [æ•¸æ“šæµè©³è§£](data-flow.md)

---

æœ€å¾Œæ›´æ–°ï¼š2025-11-28
